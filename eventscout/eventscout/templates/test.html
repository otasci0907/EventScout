<!DOCTYPE html>
<html>
<head>
    <title>Geolocation Example</title>
</head>
<body>
    <button onclick="getLocation()">Get Location</button>
    <p id="location"></p>
    {% for event in data.events %}
      <p> made it here</p>
        <div>
        <h2>{{ event.name }}</h2>
        <p>Location: {{ event.location }}</p>
        <p>Date: {{ event.date }}</p>
        <p>Time: {{ event.time }}</p>
        <p>Description: {{ event.description }}</p>
        </div>
    {% endfor %}
    <p>{{data.API_KEY}}</p>
    <iframe
      width="600"
      height="450"
      style="border:0"
      loading="lazy"
      allowfullscreen
      referrerpolicy="no-referrer-when-downgrade"
      src="https://www.google.com/maps/embed/v1/place?key={{data.API_KEY}}&q=Space+Needle,Seattle+WA">
    </iframe>
    <script>
    function getLocation() {
      console.log("Getting location...");
      if (navigator.geolocation) {
        console.log("Geolocation is supported");
        navigator.geolocation.getCurrentPosition(showPosition, showError, { maximumAge: 600000 });
      } else {
        document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function showPosition(position) {
      console.log("Position found");
      let latitude = position.coords.latitude;
      let longitude = position.coords.longitude;
      document.getElementById("location").innerHTML = "Latitude: " + latitude + 
      "<br>Longitude: " + longitude;
      sendLocationData(latitude, longitude);
    }

    function showError(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("location").innerHTML = "User denied the request for Geolocation."
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("location").innerHTML = "Location information is unavailable."
          break;
        case error.TIMEOUT:
          document.getElementById("location").innerHTML = "The request to get user location timed out."
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("location").innerHTML = "An unknown error occurred."
          break;
      }
    }

    const sendLocationData = (latitude, longitude) => {
      const url = "{% url 'locations' %}"; 
      const csrfToken = "{{ csrf_token }}";
      const data = {
        latitude: latitude,
        longitude: longitude,
        csrfmiddlewaretoken: csrfToken
      };
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data),
      })
      .then(response => console.log(response))
      .then(data => {
        console.log('Success:', data);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    };
    </script>
</body>
</html>