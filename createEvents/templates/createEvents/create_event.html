{% extends 'base.html' %}
{% load static %}

{% block title %}Create Event | EventScout{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
    <h1 class="mb-4">Event Dashboard</h1>

    <div class="d-flex align-items-center gap-2 mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">
            + Create New Event
        </button>
    
        <button type="button"
                class="btn btn-outline-info"
                data-bs-toggle="modal"
                data-bs-target="#chatGPTModal">
            Ask ChatGPT for Ideas
        </button>
    </div>
    
    <div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="text-align: center">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="createEventModalLabel">{% if editing %} Edit Event {% else %} Create New Event {% endif %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        {{ form.as_p }}
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">{% if editing %} Edit Event {% else %} Create Event {% endif %}</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <h3 class="mt-5">My Events</h3>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Date & Time</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            {% for event in your_events %}
            <tr>
                <td>{{ event.title }}</td>
                <td>{{ event.start_time|date:"M d, Y - H:i" }}</td>
                <td>{{ event.location }}</td>
                <td>
                    <a href="{% url 'events.edit_event' event.id %}" class="btn btn-warning">Edit</a>
                    <a href="{% url 'events.delete_event' event.id %}" class="btn btn-danger">Delete</a>
                </td>           
            </tr>
            {% empty %}
            <tr>
                <td colspan="3">You haven’t created any events yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% if editing %}
<script>
  var myModal = new bootstrap.Modal(document.getElementById('createEventModal'), {})
  myModal.toggle()
</script>
{% endif %}
{# -------------------- ChatGPT Assistant button & modal -------------------- #}

<div class="modal fade" id="chatGPTModal" tabindex="-1"
     aria-labelledby="chatGPTModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chatGPTModalLabel">
          Event Idea Assistant
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label fw-semibold">Your question</label>
          <textarea id="chat-input" class="form-control"
                    rows="3"
                    placeholder="e.g. Any creative themes for a charity 5 k?"></textarea>
        </div>
        <button id="chat-send" class="btn btn-primary w-100">
          Ask ChatGPT
        </button>

        <hr>
        <pre id="chat-output"
             class="bg-light p-3 rounded border"
             style="min-height:8rem; white-space:pre-wrap;"></pre>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.getElementById('chat-send').addEventListener('click', async () => {
  const question = document.getElementById('chat-input').value.trim();
  if (!question) return;

  // Optionally add current form values so the model has context
  const title = document.querySelector('#id_title')?.value || '';
  const descr = document.querySelector('#id_description')?.value || '';

  const out = document.getElementById('chat-output');
  out.textContent = "Thinking…";

  try {
    const resp = await fetch("{% url 'events.chatgpt' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ question, title, descr }),
    });
    if (!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    out.textContent = data.answer;
  } catch (err) {
    out.textContent = "Error: " + err;
  }
});
</script>
{% endblock %}

{% endblock %}
